#!/usr/bin/env bash

THEMES_DIR="$MYARCHY_DIR/files/themes"

init_theme() {
	if [[ ! -d "$THEMES_DIR/current" ]]; then
		echo "Setting default theme"
		set_theme "$(list_themes | head -n 1)"
	fi
}

get_theme() {
	local theme_path=$(readlink -f "$THEMES_DIR/current")
	local theme_name=$(basename "$theme_path")

	echo "$theme_name"
}

list_themes() {
	fd --glob "*" "$THEMES_DIR/" --format {/} --max-depth 1
}

add_theme() {
	local new_theme="$1"
	local base_theme="$2"

	cp -r "$THEMES_DIR/$base_theme" "$THEMES_DIR/$new_theme"

	if [[ -f "$THEMES_DIR/$base_theme/palette.txt" ]]; then
		cp "$THEMES_DIR/$base_theme/palette.txt" "$THEMES_DIR/$new_theme/palette.txt"
		echo "Copied palette from '$base_theme'. Edit $THEMES_DIR/$new_theme/palette.txt for the new colors."
		echo "When ready, remap old colors to the new palette:"
		echo "  myarchy-palette remap-files $new_theme --from-theme $base_theme --write"
	fi

	echo "Created theme '$new_theme' from '$base_theme'."
}

set_theme() {
	ln -sfT "$THEMES_DIR/$1" "$THEMES_DIR/current"

	myarchy-wallpaper apply-preferred
	myarchy-cursor apply-preferred
}

case "$1" in
init)
	init_theme
	;;
get)
	get_theme
	;;
list)
	list_themes
	;;
add)
	add_theme "$2" "$3"
	;;
set)
	set_theme "$2"
	;;
*)
	echo "Usage: myarchy-theme {init|get|list|add <new_theme> [base_theme]|set <theme>}" >&2
	exit 1
	;;
esac
