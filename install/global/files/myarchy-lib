#!/usr/bin/env bash

BACKUPS_DIR="/var/backups"

init() {
	sudo mkdir -p $BACKUPS_DIR
	sudo chmod 777 $BACKUPS_DIR
}

version_ge() {
	if [ "$1" = "$2" ]; then
		return 0
	fi

	if [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" != "$1" ]; then
		return 0
	else
		return 1
	fi
}

backup_file() {
	path="$1"

	if test -L "$path"; then
		return 0
	fi

	if ! test -e "$path"; then
		return 0
	fi

	timestamp=$(date +%Y%m%d_%H%M%S)

	backup_path="$BACKUPS_DIR/$path.${timestamp}"

	mkdir -p "$(dirname "$backup_path")"
	cp -r "$path" "$backup_path" && echo "backup created ${backup_path}"
}

robust_copy() {
	source="$1"
	target="$2"

	backup_file "$target"
	rm -rf "$target" && echo "removed $target"
	mkdir -p "$(dirname "$target")"
	cp -rf $source $target && echo "copied $source -> $target"
}

robust_link() {
	target="$1"
	link_name="$2"

	backup_file "$link_name"
	rm -rf "$link_name" && echo "removed $link_name"
	mkdir -p "$(dirname "$link_name")"
	ln -sT "$target" "$link_name" && echo "symlinked $link_name -> $target" || echo "failed to create symlink $target $link_name"
}

robust_insert_with_marker() {
	path="$1"
	marker="$2"
	content="$3"
	comment_char_opening="${4:-#}"
	comment_char_closing="${5:-#}"

	start="$comment_char_opening AUTOGENERATED START $marker $comment_char_closing"
	end="$comment_char_opening AUTOGENERATED END $marker $comment_char_closing"

	backup_file "$path"

	# Create temp file to preserve original location
	temp_file=$(mktemp)

	if grep -Fq "$start" "$path" 2>/dev/null; then
		# Replace content between markers
		start_line=$(grep -Fn "$start" "$path" | cut -d: -f1)
		end_line=$(grep -Fn "$end" "$path" | cut -d: -f1)

		# Copy before, insert new content, copy after
		{
			head -n $((start_line - 1)) "$path" 2>/dev/null || true
			printf '%s\n%s\n%s\n' "$start" "$content" "$end"
			tail -n +$((end_line + 1)) "$path" 2>/dev/null || true
		} >"$temp_file"
		cp "$temp_file" "$path"
	else
		# Append new content if markers don't exist
		cp "$path" "$temp_file"
		printf '%s\n%s\n%s\n' "$start" "$content" "$end" >>"$temp_file"
		cp "$temp_file" "$path"
	fi

	rm -f "$temp_file"
	echo "inserted content with marker $marker in $path"
}

render_template() {
	template_file="$1"
	output_file="$2"

	j2 "$template_file" >"$output_file" && echo "rendered template $template_file to $output_file"
}

case "$1" in
"init")
	init
	;;
version-ge)
	version_ge "$2" "$3"
	;;
backup-file)
	backup_file "$2"
	;;
robust-copy)
	robust_copy "$2" "$3"
	;;
robust-link)
	robust_link "$2" "$3"
	;;
robust-insert-with-marker)
	robust_insert_with_marker "$2" "$3" "$4" "$5" "$6"
	;;
render-template)
	render_template "$2" "$3"
	;;
*)
	echo "Unknown command: $1"
	exit 1
	;;
esac
